---
title: "Geospatial dashboard for LTFEM plots and trees"
output:
  html_document:
    toc: true
    toc_float:
      collapsed: false
    toc_depth: 3
    code_folding: hide
    df_print: kable
---

```{r load libraries and files, include=FALSE}
#Load libraries ----
library(sf)
library(dplyr)
library(tmap)
library(leaflet)

#Load data ----
trees     <- st_read("../LTFEM_Veg/out/shapefiles/mandai/trees_points.shp")
bigTrees  <- st_read("../LTFEM_Veg/out/shapefiles/mandai/bigTrees_points.shp")
saplings  <- st_read("../LTFEM_Veg/out/shapefiles/mandai/saplings_points.shp")
mandai_10by10 <- st_read("../LTFEM_Veg/out/shapefiles/mandai/mandai_10by10_shapefile.shp")
mandai_20by20 <- st_read("../LTFEM_Veg/out/shapefiles/mandai/mandai_20by20_shapefile.shp")
mandai_40by40 <- st_read("../LTFEM_Veg/out/shapefiles/mandai/mandai_40by40_shapefile.shp")
```


```{r, echo=FALSE, message=FALSE, warning=FALSE}
#Convert to WGS84 for leaflet
trees_wgs     <- st_transform(trees, 4326)
bigTrees_wgs  <- st_transform(bigTrees, 4326)
saplings_wgs  <- st_transform(saplings, 4326)
mandai_10by10_wgs <- st_transform(mandai_10by10, 4326)
mandai_20by20_wgs <- st_transform(mandai_20by20, 4326)
mandai_40by40_wgs <- st_transform(mandai_40by40, 4326)

#Scaling DBH ----
trees_wgs <- trees_wgs %>% mutate(radius = DBH / 200) #adjust denominator for scale
bigTrees_wgs <- bigTrees_wgs %>% mutate(radius = DBH / 200)
saplings_wgs <- saplings_wgs %>% mutate(radius = DBH / 200)

#Legend making function ----
addLegendCustom <- function(map, colors, sizes, labels, opacity = 0.7) {
    map <- addLegend(map,
              position = "bottomright",
              colors = colors,
              labels = labels,
              title = "Legend",
              opacity = opacity
    )
    return(map)
}

#making leaflet----
leaflet(options = leafletOptions(maxZoom = 30, minZoom = 12)) %>%
    addProviderTiles(providers$OpenStreetMap.Mapnik, options = providerTileOptions(maxZoom = 30)) %>%
    
    # --- Squares ---
    addPolygons(
        data = mandai_40by40_wgs,
        color = "orange",
        weight = 2,
        fill = FALSE,
        group = "40x40 Plots",
        popup = ~paste0("<b>Plot ID:</b> ", alias)
    ) %>%
    
    addPolygons(
        data = mandai_20by20_wgs,
        color = "green",
        weight = 2,
        fill = FALSE,
        group = "20x20 Plots",
        popup = ~paste0("<b>Plot ID:</b> ", alias)
    ) %>%
    
    addPolygons(
        data = mandai_10by10_wgs,
        color = "blue",
        weight = 2,
        fill = FALSE,
        group = "10x10 Plots",
        popup = ~paste0("<b>Plot ID:</b> ", plotID)
    ) %>%
    
    # --- Trees layer ---
    addCircles(
    # addCircleMarkers(
        data = trees_wgs,
        color = "darkgreen",
        fillOpacity = 0.7,
        stroke = TRUE,
        weight = 1,
        radius = ~radius,
        group = "Trees",
        popup = ~paste0(
            "<b>treeID:</b> ", treeID,
            "<br><b>Species:</b> ", species,
            "<br><b>DBH:</b> ", round(DBH, 1), " cm"
        )
    ) %>%
    
    # --- Big Trees layer ---
    addCircles(
    # addCircleMarkers(
        data = bigTrees_wgs,
        color = "orange",
        fillOpacity = 0.7,
        stroke = TRUE,
        weight = 1,
        radius = ~radius,
        group = "Big Trees",
        popup = ~paste0(
            "<b>bigTreeID:</b> ", bigTrID,
            "<br><b>Species:</b> ", species,
            "<br><b>DBH:</b> ", round(DBH, 1), " cm"
        )
    ) %>%
    
    # --- Saplings layer ---
    addCircles(
    # addCircleMarkers(
        data = saplings_wgs,
        color = "blue",
        fillOpacity = 0.6,
        stroke = TRUE,
        weight = 1,
        radius = ~radius,
        group = "Saplings",
        popup = ~paste0(
            "<b>saplingID:</b> ", treeID,
            "<br><b>Species:</b> ", species,
            "<br><b>DBH:</b> ", round(DBH, 1), " cm"
        )
    ) %>%
    
    # --- 3. Layer control toggle ---
    addLayersControl(
        overlayGroups = c("Trees", "Big Trees", "Saplings", "10x10 Plots", "20x20 Plots", "40x40 Plots"),
        options = layersControlOptions(collapsed = FALSE)
    ) %>%
    
    # --- 4. Add a legend for DBH ---
    addLegendCustom(
        colors = c("blue", "darkgreen", "orange"),
        sizes = c(5, 20, 40),
        labels = c( "Saplings", "Trees", "Big Trees")
    )
```
