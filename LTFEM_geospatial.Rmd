---
title: "LTFEM plots and trees"
output:
  html_document:
    toc: false
    toc_float:
      collapsed: false
    toc_depth: 3
    df_print: kable
---

```{r load libraries and files, include=FALSE}
#Load libraries ----
library(sf)
library(tidyverse)
library(leaflet)

#Load data ----

trees_layerNames <- c("Mandai_saplings_2025",
  "Mandai_trees_2023",
  "Mandai_bigTrees_2023",
  "WYK_saplings_2024",
  "WYK_trees_2022",
  "WYK_bigTrees_2022",
  "NSSF_saplings_2024",        
  "NSSF_trees_2024",
  "NSSF_bigTrees_2024",
  "NatureParks_trees_2023",
  "NatureParks_bigTrees_2023"
  )
trees <-  trees_layerNames %>%
    lapply(function(x) {
        st_read(paste0("../LTFEM_Veg/data/classified/geospatial/", x, ".geojson")) %>%
            st_transform(4326) %>%
            mutate(radius = DBH / 200) #adjust denominator for scale
    }) %>%
    set_names(trees_layerNames)

boundaries_layerNames <-c("Mandai_subplot_boundaries_reprojected",
  "Mandai_corePlot_boundaries_reprojected",
  "Mandai_extendedPlot_boundaries_reprojected",
  "WYK_subplot_boundaries_reprojected",
  "WYK_corePlot_boundaries_reprojected",
  "WYK_extendedPlot_boundaries_reprojected",
  "NSSF_subplot_boundaries_reprojected",
  "NSSF_corePlot_boundaries_reprojected",
  "NSSF_extendedPlot_boundaries_reprojected",
  "NatureParks_corePlot_boundaries_reprojected",
  "NatureParks_extendedPlot_boundaries_reprojected")
boundaries <- boundaries_layerNames %>%
    lapply(function(x) {
        st_read(paste0("../LTFEM_Veg/out/geospatial/", x, ".geojson")) %>% 
                    st_transform(4326)
    }) %>%
    set_names(boundaries_layerNames)

rm(trees_layerNames, boundaries_layerNames)
```


```{r making leaflet, echo=FALSE, message=FALSE, warning=FALSE}
leaflet(options = leafletOptions(maxZoom = 30, minZoom = 12)) %>%
    addProviderTiles(providers$OpenStreetMap.Mapnik, options = providerTileOptions(maxZoom = 30)) %>%
    
    # --- boundaries ---
    addPolygons(
        data = boundaries$Mandai_extendedPlot_boundaries_reprojected,
        color = "red",
        weight = 2,
        fill = FALSE,
        group = "Mandai 40x40 Plots",
        popup = ~ paste0("<b>Plot ID:</b> ", plotID)
    ) %>%
    
    addPolygons(
        data = boundaries$Mandai_corePlot_boundaries_reprojected,
        color = "red",
        weight = 2,
        fill = FALSE,
        group = "Mandai 20x20 Plots",
        popup = ~ paste0("<b>Plot ID:</b> ", plotID)
    ) %>%
    
    addPolygons(
        data = boundaries$Mandai_subplot_boundaries_reprojected,
        color = "red",
        weight = 2,
        fill = FALSE,
        group = "Mandai 10x10 Plots",
        popup = ~ paste0("<b>Plot ID:</b> ", plotID)
    ) %>%
    
    addPolygons(
        data = boundaries$WYK_extendedPlot_boundaries_reprojected,
        color = "black",
        weight = 2,
        fill = FALSE,
        group = "WYK 40x40 Plots",
        popup = ~ paste0("<b>Plot ID:</b> ", plotID)
    ) %>%
    
    addPolygons(
        data = boundaries$WYK_corePlot_boundaries_reprojected,
        color = "black",
        weight = 2,
        fill = FALSE,
        group = "WYK 20x20 Plots",
        popup = ~ paste0("<b>Plot ID:</b> ", plotID)
    ) %>%
    
    addPolygons(
        data = boundaries$WYK_subplot_boundaries_reprojected,
        color = "black",
        weight = 2,
        fill = FALSE,
        group = "WYK 10x10 Plots",
        popup = ~ paste0("<b>Plot ID:</b> ", plotID)
    ) %>%
    
    addPolygons(
        data = boundaries$NSSF_extendedPlot_boundaries_reprojected,
        color = "blue",
        weight = 2,
        fill = FALSE,
        group = "NSSF 40x40 Plots",
        popup = ~ paste0("<b>Plot ID:</b> ", plotID,
                         "<br><b>Plot type:</b> ", plotType_wetdry)
    ) %>%
    
    addPolygons(
        data = boundaries$NSSF_corePlot_boundaries_reprojected,
        color = "blue",
        weight = 2,
        fill = FALSE,
        group = "NSSF 20x20 Plots",
        popup = ~ paste0("<b>Plot ID:</b> ", plotID,
                         "<br><b>Plot type:</b> ", plotType_wetdry)
    ) %>%
    
    addPolygons(
        data = boundaries$NSSF_subplot_boundaries_reprojected,
        color = "blue",
        weight = 2,
        fill = FALSE,
        group = "NSSF 10x10 Plots",
        popup = ~ paste0("<b>Plot ID:</b> ", plotID,
                         "<br><b>Plot type:</b> ", plotType_wetdry)
    ) %>%    
    
    addPolygons(
        data = boundaries$NatureParks_extendedPlot_boundaries_reprojected,
        color = "purple",
        weight = 2,
        fill = FALSE,
        group = "Natureparks 40x40 Plots",
        popup = ~ paste0("<b>Plot ID:</b> ", plotID)
    ) %>%
    
    addPolygons(
        data = boundaries$NatureParks_corePlot_boundaries_reprojected,
        color = "purple",
        weight = 2,
        fill = FALSE,
        group = "Natureparks 20x20 Plots",
        popup = ~ paste0("<b>Plot ID:</b> ", plotID)
    ) %>%
    
    # addPolygons(
    #     data = boundaries$NatureParks_subplot_boundaries_reprojected,
    #     color = "purple",
    #     weight = 2,
    #     fill = FALSE,
    #     group = "Natureparks 10x10 Plots",
    #     popup = ~ paste0("<b>Plot ID:</b> ", plotID)
    # ) %>%        
    
    # --- Trees layer ---
    addCircles(
        data = trees$Mandai_trees_2023,
        color = "darkgreen",
        fillOpacity = 0.7,
        stroke = TRUE,
        weight = 1,
        radius = ~ radius,
        group = "Mandai Trees",
        popup = ~ paste0(
            "<b>Species:</b> ", species,
            "<br><b>DBH:</b> ", round(DBH, 1), " cm"
        )
    ) %>%
    
    addCircles(
        data = trees$WYK_trees_2022,
        color = "darkgreen",
        fillOpacity = 0.7,
        stroke = TRUE,
        weight = 1,
        radius = ~ radius,
        group = "WYK Trees",
        popup = ~ paste0(
            "<b>Species:</b> ", species,
            "<br><b>DBH:</b> ", round(DBH, 1), " cm"
        )
    ) %>%
    
    addCircles(
        data = trees$NSSF_trees_2024,
        color = "darkgreen",
        fillOpacity = 0.7,
        stroke = TRUE,
        weight = 1,
        radius = ~ radius,
        group = "NSSF Trees",
        popup = ~ paste0(
            "<b>Species:</b> ", species,
            "<br><b>DBH:</b> ", round(DBH, 1), " cm"
        )
    ) %>%
    
    addCircles(
        data = trees$NatureParks_trees_2023,
        color = "darkgreen",
        fillOpacity = 0.7,
        stroke = TRUE,
        weight = 1,
        radius = ~ radius,
        group = "Natureparks Trees",
        popup = ~ paste0(
            "<b>Species:</b> ", species,
            "<br><b>DBH:</b> ", round(DBH, 1), " cm"
        )
    ) %>%
    
    # --- Big Trees layer ---
    addCircles(
        data = trees$Mandai_bigTrees_2023,
        color = "orange",
        fillOpacity = 0.7,
        stroke = TRUE,
        weight = 1,
        radius = ~ radius,
        group = "Mandai Big Trees",
        popup = ~ paste0(
            "<b>Species:</b> ", species,
            "<br><b>DBH:</b> ", round(DBH, 1), " cm"
        )
    ) %>%
    
    addCircles(
        data = trees$WYK_bigTrees_2022,
        color = "orange",
        fillOpacity = 0.7,
        stroke = TRUE,
        weight = 1,
        radius = ~ radius,
        group = "WYK Big Trees",
        popup = ~ paste0(
            "<b>Species:</b> ", species,
            "<br><b>DBH:</b> ", round(DBH, 1), " cm"
        )
    ) %>%
    
    addCircles(
        data = trees$NSSF_bigTrees_2024,
        color = "orange",
        fillOpacity = 0.7,
        stroke = TRUE,
        weight = 1,
        radius = ~ radius,
        group = "NSSF Big Trees",
        popup = ~ paste0(
            "<b>Species:</b> ", species,
            "<br><b>DBH:</b> ", round(DBH, 1), " cm"
        )
    ) %>%    
    
    addCircles(
        data = trees$NatureParks_bigTrees_2023,
        color = "orange",
        fillOpacity = 0.7,
        stroke = TRUE,
        weight = 1,
        radius = ~ radius,
        group = "Natureparks Big Trees",
        popup = ~ paste0(
            "<b>Species:</b> ", species,
            "<br><b>DBH:</b> ", round(DBH, 1), " cm"
        )
    ) %>%        
    
    # --- Saplings layer ---
    addCircles(
        data = trees$Mandai_saplings_2025,
        color = "blue",
        fillOpacity = 0.6,
        stroke = TRUE,
        weight = 1,
        radius = ~ radius,
        group = "Mandai Saplings",
        popup = ~ paste0(
            "<b>Species:</b> ", species,
            "<br><b>DBH:</b> ", round(DBH, 1), " cm"
        )
    ) %>%
    
    addCircles(
        data = trees$WYK_saplings_2024,
        color = "blue",
        fillOpacity = 0.6,
        stroke = TRUE,
        weight = 1,
        radius = ~ radius,
        group = "WYK Saplings",
        popup = ~ paste0(
            "<b>Species:</b> ", species,
            "<br><b>DBH:</b> ", round(DBH, 1), " cm"
        )
    ) %>%
    
    addCircles(
        data = trees$NSSF_saplings_2024,
        color = "blue",
        fillOpacity = 0.6,
        stroke = TRUE,
        weight = 1,
        radius = ~ radius,
        group = "NSSF Saplings",
        popup = ~ paste0(
            "<b>Species:</b> ", species,
            "<br><b>DBH:</b> ", round(DBH, 1), " cm"
        )
    ) %>%    
    
    # addCircles(
    #     data = trees$NatureParks_saplings_2023,
    #     color = "blue",
    #     fillOpacity = 0.6,
    #     stroke = TRUE,
    #     weight = 1,
    #     radius = ~ radius,
    #     group = "Natureparks Saplings",
    #     popup = ~ paste0(
    #         "<b>Species:</b> ", species,
    #         "<br><b>DBH:</b> ", round(DBH, 1), " cm"
    #     )
    # ) %>%
    
    # --- 3. Layer control toggle ---
    addLayersControl(
        overlayGroups = c("Mandai Saplings", "Mandai Trees", "Mandai Big Trees",
                          "Mandai 10x10 Plots", "Mandai 20x20 Plots", "Mandai 40x40 Plots",
                          "WYK Saplings", "WYK Trees", "WYK Big Trees",
                          "WYK 10x10 Plots", "WYK 20x20 Plots", "WYK 40x40 Plots",
                          "NSSF Saplings", "NSSF Trees", "NSSF Big Trees",
                          "NSSF 10x10 Plots", "NSSF 20x20 Plots", "NSSF 40x40 Plots",
                          #"Natureparks Saplings", 
                          "Natureparks Trees", "Natureparks Big Trees",
                          #"Natureparks 10x10 Plots", 
                          "Natureparks 20x20 Plots", "Natureparks 40x40 Plots"),
        options = layersControlOptions(collapsed = TRUE)
    ) %>%
    
    # --- 4. Add a legend for DBH ---
    addLegend(
        colors = c("blue", "darkgreen", "orange"),
        labels = c( "Saplings", "Trees", "Big Trees"),
        position = "bottomright",
        title = "Legend"
    )
```
